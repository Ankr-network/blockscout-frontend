name: Build and Check Earn
on: [pull_request, push]

env:
  NODE_VERSION: '16.13.0'
  HUSKY_SKIP_INSTALL: 1

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup caching for dependencies
        uses: egordm/gha-yarn-node-cache@v1

      - name: Setup Node.js environment
        uses: actions/setup-node@v2.5.0
        with:
          node-version: '16.13.0'

      - name: Install dependencies
        run: yarn install

      # TODO: enable later
      # - name: Commitlint
      #   run: git log -1 --pretty=format:"%s" | npx commitlint --verbose

      - name: Lint
        working-directory: ./packages/ankr-earn
        run: yarn lint:js

      - name: Types
        working-directory: ./packages/ankr-earn
        run: yarn types

      - name: Tests
        working-directory: ./packages/ankr-earn
        run: yarn test:coverage

  build_production:
    name: Build production
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v2
      - name: Setup caching for dependencies
        uses: egordm/gha-yarn-node-cache@v1

      - name: Setup Node.js environment
        uses: actions/setup-node@v2.5.0
        with:
          node-version: '16.13.0'

      - name: Install dependencies
        run: yarn install

      - name: Build
        working-directory: ./packages/ankr-earn
        run: |
          yarn build:prod
          yarn postbuild

  build_stage:
    name: Build stage
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v2
      - name: Setup caching for dependencies
        uses: egordm/gha-yarn-node-cache@v1

      - name: Setup Node.js environment
        uses: actions/setup-node@v2.5.0
        with:
          node-version: '16.13.0'

      - name: Install dependencies
        run: yarn install

      - name: Build
        working-directory: ./packages/ankr-earn
        run: |
          yarn build:prod
          yarn postbuild
      
